#!/usr/bin/env bash

branchname=$(git symbolic-ref -q --short HEAD)
# add database name into your git config file
# so it takes that database name instead of defaulting to the branch 
suffix=${1}

if [[ -z "${suffix}" || "${sufix}" = "-v" ]] ; then
  echo "options: -b to set to branch name, -X to clear"
  echo
  echo "current sufix '$(git config --get branch.$(git branch-name).suffix)'"
  exit
fi

if [[ "${suffix}" = "-X" ]] ; then
  echo "sufix was '$(git config --get branch.$(git branch-name).suffix)'"
  git config --unset-all -- branch.${branchname}.suffix
  echo "sufix now '$(git config --get branch.$(git branch-name).suffix)'"
  exit
fi

if [[ "${suffix}" = "-b" ]] ; then
  suffix="_${branchname}"
elif [[ "${suffix}" != [-_]* ]] ; then
  suffix="_${suffix}"
fi

#prune off plm_development_ if that was entered
suffix=${suffix#*_development}
suffix=${suffix#*_test}
suffix=${suffix//\//_}

#git config branch.${branchname}.database vmdb_development_${suffix}
#git config branch.${branchname}.test vmdb_test_${suffix}

echo "git config branch.${branchname}.suffix ${suffix}"
git config branch.${branchname}.suffix ${suffix}

exit
database.yml:

# PostgreSQL
#
# <%   $db_count ||=0 ; $db_count +=1 %>
# <%   db_suffix = `git config branch.$(git symbolic-ref -q --short HEAD).suffix`.chomp rescue nil %>
# <%   evm_version = File.read(File.join(Rails.root, 'VERSION')).chomp rescue 'master' %>
# <%   db_suffix ||= (evm_version == 'master') ? '' : "_#{evm_version.split('.')[0..1].join('_')}" %>
# < %   STDERR.puts "** EVM vmdb_#{Rails.env.to_s}#{db_suffix} ** #{$db_count}" % >
---
base: &base
  adapter: postgresql
  encoding: utf8
  username: postgres
  pool: 5
  wait_timeout: 5
  min_messages: warning
  region: 5

development:
  <<: *base
  database: vmdb_development<%=db_suffix %>
  min_messages: notice
